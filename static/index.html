<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Home</title>

    <link rel="stylesheet" type="text/css" href="../static/css/styles.css">
    <link rel="stylesheet" type="text/css" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../static/css/Chart.min.css">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">

    <script src="../static/js/vue.js"></script>
    <script src="../static/js/vue-router.js"></script>
    <script src="../static/js/axios.min.js"></script>
    <script src="../static/js/Chart.bundle.min.js"></script>
    <script src="../static/js/moment.js"></script>
    <script src="../static/js/dump.js"></script>
    <script src="../static/js/utils.js"></script>
</head>
<body>
    
    <div id="app">
        <div v-if="!login">
            <login></login>
        </div>
        <div v-if="login">
            <navbar></navbar>
            <lateralmenu>    
                <router-view></router-view>
            </lateralmenu>
        </div>
        
    </div>
    
    <template id="navbar">
        
            <nav class="navbar bg-blue mb-4">            
                <button class="btn btn-outline-light" id="menu-toggle">Menu</button>
            </nav>
            
    </template>

    <template id="relatorio-gen">
        <div class="box mb-4">
            <div class="table-responsive">
                <p style="text-align:center;font-size: 2.5em" class="display-4">{{titulo}}</p>
                <table class="table table-sm table-hover">
                    <thead>
                        <tr style="text-align: center">
                            <th class="col" :colspan="cabecalho.length + 1"> {{mes}} </th>
                        </tr>
                        <tr>
                            <th class="col" v-for="index in cabecalho" :key="index">{{index}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="fun in funcionarios" :key="fun.codfun">
                            <td>{{fun.codfun}}</td>
                            <td>{{fun.nomefun}}</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr style="text-align: center">
                            <th :colspan="cabecalho.length + 1" >{{funcionarios.length}} FUNCIONARIOS</th>
                        </tr>
                    </tfoot>
                </table>    
            </div> 
        </div>          
    </template>

    <template id="relatorio">
        <div class="container">
                <relatorio-gen :titulo="'TEMPO ATIVO'"></relatorio-gen>
                <relatorio-gen :titulo="'QUANTIDADE APROVAÇÃO'"></relatorio-gen>
                <relatorio-gen :titulo="'VENDAS POR HORA'"></relatorio-gen>
        </div>
        
    </template>

    <template id="dashboard">
        <div class="container p-4 mb-4">
            <media-global></media-global>
            <div class="box">
                <canvas id="grafico"></canvas>
            </div>
        </div>
    </template>

    <template id="media-global">
        <div class="container">
            <div class="justify-content-center">
                <p class="display-4" style="font-size: 2.2em;text-align: center">{{titulo}}</p>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>FUNCIONARIO</th>
                            <th>MEDIA GLOBAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="fun in funcionarios">
                            <td>{{fun.codfun}}</td>
                            <td>{{fun.nomefun}}</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3" style="text-align: center">
                                {{funcionarios.length}} - FUNCIONARIOS
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
        </div>
    </template>

    <template id="gerenciamento">
        <div class="container p-4">
            <h1>Esta perdido?</h1>
        </div>
    </template>

    <template id="lateralmenu">
            

            <div class="d-flex" id="wrapper">

                    <!-- Sidebar -->
                    <div class="bg-roxo border-right " id="sidebar-wrapper">
                      <div class="list-group list-group-flush bg-roxo">
                        <router-link to="/" class="list-group-item list-group-item-action"><img id="logo" src="../static/img/logo_black.svg" alt="Logo"></router-link>
                        <router-link to="/" class="list-group-item list-group-item-action">Dashboard</router-link>
                        <router-link to="/relatorio" class="list-group-item list-group-item-action">Relatorio</router-link>
                        <router-link to="/Gerenciamento" class="list-group-item list-group-item-action">Gerenciamento</router-link>
                        <a href="#" class="list-group-item list-group-item-action" @click.stop.prevent="logout()">Sair</a>
                      
                        </div>

                        <div class="copyright">
                            <p class="display-4" style="font-size: 1em">@ HandyMobile 2019</p> 
                            <p class="display-4" style="font-size: 1em">Todos os direitos Reservados</p>    
                        </div>
                        
                    </div>
                    
                    <slot></slot>
                
            </div>

    </template>

    <template id="login">
        <div class="container">
            <div class="box login">
                <form>

                    <div class="form-group">
                        <label class="display-4" style="font-size: 1.2em" for="nome_usuario">Nome de Usuario</label>
                        <input v-model="username" type="text" class="form-control" placeholder="Nome de Usuario">
                    </div>

                    <div class="form-group">
                        <label class="display-4" style="font-size: 1.2em" for="Senha">Senha</label>
                        <input v-model="password" type="password" class="form-control" placeholder="Senha">
                    </div>
                    
                    <button type="submit" class="float-right btn btn-outline-primary" @click.stop.prevent="login()">Entrar</button>
                
                </form>
            </div>

            <!-- Modal -->
            <div class="modal fade" id="erro" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document"> 
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Herrar é Umano Tente Novamente</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <h5>Usuario ou senha incorretos</h5>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </template>

    <script src="../static/js/jquery-3.3.1.slim.min.js"></script>
    <script src="../static/js/popper.min.js"></script>
    <script src="../static/js/bootstrap.min.js"></script>

    <script>
        var AUTH_TOKEN;

        axios.defaults.baseURL = 'http://127.0.0.1:5000/api';

        var login = Vue.component("login",{
            template:"#login",
            data(){
                return{
                    username: null,
                    password: null
                }
            },
            methods:{
                login(){
                    axios({
                            method: 'post',
                            url: '/auth',
                            data: {
                                username: this.username,
                                password: this.password
                        }
                        }).then(function(response){
                                this.AUTH_TOKEN = response.data.access_token;
                                localStorage.setItem("AUTH_TOKEN",AUTH_TOKEN)
                                app.$data.login = localStorage.getItem("AUTH_TOKEN")
                                axios.defaults.headers.common['Authorization'] = "JWT " + localStorage.getItem("AUTH_TOKEN");
                                axios.defaults.headers.common['Content-Type'] = 'application/json';
                        }).catch(err => {
                            $("#erro").modal("toggle")
                            console.error(err)
                        })
                    }
            }});

        var media = Vue.component("media-global",{
            template:"#media-global",
            mounted(){
                let vm = this
                axios({
                        method: 'get',
                        url: '/consulta/funcionarios'
                        }).then(function(response){
                                vm.funcionarios = response.data
                        }).catch(err => console.error(err))
                
            },
            data(){
                return{
                    titulo:getMes() +" - "+ ( moment().year() ),
                    funcionarios:[]
                }
            }
        })

        var relatorio_gen =  Vue.component("relatorio-gen",{
            template:"#relatorio-gen",
            mounted(){
                let vm = this
                axios({
                        method: 'get',
                        url: '/consulta/funcionarios'
                        }).then(function(response){
                                vm.funcionarios = response.data
                        }).catch(err => console.error(err))
                
            },
            data(){
                return{
                    cabecalho:["#","FUNCIONARIO"].concat(getDays()),
                    mes: getMes(),
                    funcionarios: []
                }
            },
            props:{
                titulo:String,
            }
        })
        var relatorio = Vue.component("relatorio",{
            template:"#relatorio"
        });

        var dashboard = Vue.component("dashboard",{
            template:"#dashboard",

            mounted(){
                
                var ctx = document.getElementById('grafico');

                var myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange','Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                        datasets: [{
                            label: '# of Votes',
                            data: [12, 19, 3, 5, 2, 3, 12, -19, 3, 5, 2, 3],
                            backgroundColor: [],
                            borderColor: [],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });
            }
        });

        var gerenciamento = Vue.component("gerenciamento",{ template:"#gerenciamento"});

        var lateralmenu = Vue.component("lateralmenu",{ 
            template:"#lateralmenu",
            created(){
            
                $("#menu-toggle").click(function(e) {
                    e.preventDefault();
                $("#wrapper").toggleClass("toggled");
                })
            
            },
            methods:{
                logout(){
                    app.login = null;
                    localStorage.removeItem("AUTH_TOKEN")
                    AUTH_TOKEN = null;
                    axios.defaults.headers.common['Authorization'] = null;
                }    
            } });

        var navbar = Vue.component("navbar",{ template:"#navbar"});

        var router = new VueRouter({
            routes:[
                { 
                    path:"/relatorio", 
                    name:"Relatorio",
                    component:relatorio ,
                    meta:{
                        title:"Relatorio"
                    } 
                },
                { 
                    path:"/",
                    name:"Dashboard",
                    component:dashboard,
                    meta:{
                        title:"Dashboard"
                    } 
                },
                { 
                    path:"/gerenciamento",
                    name:"Gerenciamento",
                    component: gerenciamento,
                    meta:{
                        title:"Gerenciamento"
                    }
                 }
            ]
        });
        
        var app = new Vue(
                            { 
                                el:"#app",
                                router,
                                data:{
                                    login: localStorage.getItem("AUTH_TOKEN"),
                                    erro: null
                                }
                            }
                         );
        
        document.title = "MAPA DE DESEMPENHO"

    </script>

   
</body>
</html>