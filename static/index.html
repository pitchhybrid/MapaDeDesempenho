<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Home</title>

    <link id="favicon" rel="shortcut icon" type="image/png" href="../favicon.ico">
    <link rel="stylesheet" type="text/css" href="../static/css/styles.css">
    <link rel="stylesheet" type="text/css" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../static/css/Chart.min.css">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">
    <script src="../static/js/all.js"></script>
    <script src="../static/js/vue.js"></script>
    <script src="../static/js/vue-router.js"></script>
    <script src="../static/js/axios.min.js"></script>
    <script src="../static/js/Chart.bundle.min.js"></script>
    <script src="../static/js/moment.js"></script>
    <script src="../static/js/dump.js"></script>
    <script src="../static/js/utils.js"></script>
</head>
<body>
    
    <div id="app">
        <div v-if="!login">
            <login></login>
        </div>
        <div v-if="login">
            <navbar></navbar>
            <lateralmenu>    
                <router-view></router-view>
            </lateralmenu>
        </div>
        
    </div>
    
    <template id="navbar">
        
            <nav class="navbar bg-blue mb-4">            
                <button class="btn btn-outline-light" @click.stop.prevent="toggle()">Menu</button>
            </nav>
            
    </template>

    <template id="relatorio-gen">
        <div class="box mb-4">
            <div class="table-responsive">
                <p style="text-align:center;font-size: 2.5em" class="display-4">{{titulo}}</p>
                <table class="table table-sm table-hover">
                    <thead>
                        <tr style="text-align: center">
                            <th class="col" :colspan="cabecalho.length + 1"> {{mes}} </th>
                        </tr>
                        <tr>
                            <th class="col" v-for="index in cabecalho" :key="index">{{index}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="fun in funcionarios" :key="fun.codfun">
                            <td>{{fun.codfun}}</td>
                            <td>{{fun.nomefun}}</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr style="text-align: center">
                            <th :colspan="cabecalho.length + 1" >{{funcionarios.length}} FUNCIONARIOS</th>
                        </tr>
                    </tfoot>
                </table>    
            </div> 
        </div>          
    </template>

    <template id="relatorio">
        <div class="container">
                <relatorio-gen :titulo="'TEMPO ATIVO'"></relatorio-gen>
                <relatorio-gen :titulo="'QUANTIDADE APROVAÇÃO'"></relatorio-gen>
                <relatorio-gen :titulo="'VENDAS POR HORA'"></relatorio-gen>
        </div>
        
    </template>

    <template id="dashboard">
        <div class="container p-4 mb-4">
            <media-global></media-global>
            <div class="box">
                <canvas id="grafico"></canvas>
            </div>
        </div>
    </template>

    <template id="media-global">
        <div class="container">
            <div class="justify-content-center">
                <p class="display-4" style="font-size: 2.2em;text-align: center">{{titulo}}</p>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>FUNCIONARIO</th>
                            <th>MEDIA GLOBAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="fun in funcionarios">
                            <td>{{fun.codfun}}</td>
                            <td>{{fun.nomefun}}</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3" style="text-align: center">
                                {{funcionarios.length}} - FUNCIONARIOS
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
        </div>
    </template>

    <template id="gerenciamento">
        
        <div class="container p-4">
            <gerenciamento-gen :titulo="'Usuarios'" :usuarios="usuarios"  id="usuario"></gerenciamento-gen>

            <gerenciamento-gen :titulo="'Funcionarios'" :funcionarios="funcionarios" id="funcionario"></gerenciamento-gen>
        </div>

    </template>

    <template id="gerenciamento-gen">
        <div class="justify-content-center">
            <template v-if="usuarios">
                <button class="btn btn-outline-secondary" data-toggle="modal" :data-target="'#novo' + id"><i class="fas fa-user-plus"></i></button>
            </template>
            <template v-if="funcionarios">
                <button class="btn btn-outline-secondary" data-toggle="modal" :data-target="'#novo' + id"><i class="fas fa-user-plus"></i></button>
            </template>
            <p class="display-4" style="font-size: 2.2em;text-align: center">{{titulo}}</p>
            <table class="table table-hover">
                <thead v-if="usuarios">
                    <tr>
                        <th>ID</th>
                        <th>USUARIO</th>
                        <th>NOME</th>
                        <th>EMAIL</th>
                        <th>ACOES</th>
                    </tr>
                </thead>
                <thead v-if="funcionarios">
                    <tr>
                        <th width="90px">ID</th>
                        <th>FUNCIONARIO</th>
                        <th width="270px">ACOES</th>
                    </tr>
                </thead>
                <tbody v-if="usuarios">
                    <tr v-for="(usuario) in usuarios" :key="usuario.cod_user">
                        <td>{{usuario.cod_user}}</td>
                        <td>{{usuario.usuario_login}}</td>
                        <td>{{usuario.nome_usuario}}</td>
                        <td>{{usuario.email_usuario}}</td>
                        <td>
                            <button class="btn btn-outline-primary"
                                    data-toggle="modal" 
                                    :data-target="'#' + id">
                                <i class="far fa-edit"></i>
                            </button> {{getCod(usuario.cod_user)}}
                            <button class="btn btn-outline-danger" @click.stop.prevent="remUsuario(usuario.cod_user)">
                                    <i class="fas fa-user-minus"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
                <tbody v-if="funcionarios">
                    <tr v-for="funcionario in funcionarios" :key="funcionario.codfun">
                        <td>{{funcionario.codfun}}</td>
                        <td>{{funcionario.nomefun}}</td>
                        <td>
                            <button class="btn btn-outline-primary" 
                                    data-toggle="modal" 
                                    :data-target="'#' + id" >
                                <i class="far fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" @click.stop.prevent="remFuncionario(funcionario.codfun)">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
                <tfoot v-if="usuarios">
                    <tr>
                        <th colspan="3" style="text-align: center">
                            {{usuarios.length}} - USUARIOS
                        </th>
                    </tr>
                </tfoot>
                <tfoot v-if="funcionarios">
                    <tr>
                        <th colspan="3" style="text-align: center;transform: translateX(-13%)">
                            {{funcionarios.length}} - FUNCIONARIOS
                        </th>
                    </tr>
                </tfoot>
            </table>

            <!-- Modal -->
            <div class="modal fade" :id="id" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edição</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <template v-if="usuarios">
                                <label for="usuario">Usuario:. </label>
                                <input v-model="usuario" type="text" class="form-control">
                                
                                <label for="nome">Nome:. </label>
                                <input v-model="nome" type="text" class="form-control">
                                
                                <label for="email">Email:. </label>
                                <input v-model="email" type="email" class="form-control">
                                
                                <label for="senha">Senha:. </label>
                                <input v-model="senha" type="password" class="form-control">
                                
                                <label for="confirmar_senha">Confirmar senha:. </label>
                                <input v-model="repeticao_senha" type="password" class="form-control">    
                            </template>

                            <template v-if="funcionarios">
                                <label for="codigo">Codigo funcionario:.</label>
                                <input v-model="codfun" style="width: 100px" type="text" class="form-control">
                                <label for="nome">Nome do fucionario:. </label>
                                <input v-model="funcionario" type="text" class="form-control">
                            </template>
                        </div>
                        <div class="modal-footer">         
                            <template v-if="usuarios">
                                <button @click.stop.prevent="altUsuario()" type="button" class="btn btn-primary">Salvar</button>
                            </template>
                            <template v-if="funcionarios">
                                <button @click.stop.prevent="altFuncionario()" type="button" class="btn btn-primary">Salvar</button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal -->
            <div class="modal fade" :id="'novo' + id" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Novo</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <template v-if="usuarios">
                                <label for="usuario">Usuario:. </label>
                                <input v-model="usuario" type="text" class="form-control">
                                
                                <label for="nome">Nome:. </label>
                                <input v-model="nome" type="text" class="form-control">
                                
                                <label for="email">Email:. </label>
                                <input v-model="email" type="email" class="form-control">
                                
                                <label for="senha">Senha:. </label>
                                <input v-model="senha" type="password" class="form-control">
                                
                                <label for="confirmar_senha">Confirmar senha:. </label>
                                <input v-model="repeticao_senha" type="password" class="form-control">    
                            </template>

                            <template v-if="funcionarios">
                                <label for="codigo">Codigo funcionario:.</label>
                                <input v-model="codfun" style="width: 100px" type="text" class="form-control">
                                <label for="nome">Nome do fucionario:. </label>
                                <input v-model="funcionario" type="text" class="form-control">
                            </template>
                        </div>
                        <div class="modal-footer"> 
                            <template v-if="usuarios">
                                <button @click.stop.prevent="addUsuario()" type="button" class="btn btn-primary">Salvar</button>
                            </template>
                            <template v-if="funcionarios">
                                <button @click.stop.prevent="addFuncionario()" type="button" class="btn btn-primary">Salvar</button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>    
    </template>

    <template id="lateralmenu">
            

            <div class="d-flex" id="wrapper">

                    <!-- Sidebar -->
                    <div class="bg-roxo border-right " id="sidebar-wrapper">
                      <div class="list-group list-group-flush bg-roxo">
                        <router-link to="/" class="list-group-item list-group-item-action"><img id="logo" src="../static/img/logo_black.svg" alt="Logo"></router-link>
                        <router-link to="/" class="list-group-item list-group-item-action">Dashboard</router-link>
                        <router-link to="/relatorio" class="list-group-item list-group-item-action">Relatorio</router-link>
                        <router-link to="/Gerenciamento" class="list-group-item list-group-item-action">Gerenciamento</router-link>
                        <a href="#" class="list-group-item list-group-item-action" @click.stop.prevent="logout()">Sair</a>
                      
                        </div>

                        <div class="copyright">
                            <p class="display-4" style="font-size: 1em">@ HandyMobile 2019</p> 
                            <p class="display-4" style="font-size: 1em">Todos os direitos Reservados</p>    
                        </div>
                        
                    </div>
                    
                    <slot></slot>
                
            </div>

    </template>

    <template id="login">
        <div class="container">
            <div class="box login">
                <form>

                    <div class="form-group">
                        <label class="display-4" style="font-size: 1.2em" for="nome_usuario">Nome de Usuario</label>
                        <input v-model="username" type="text" class="form-control" placeholder="Nome de Usuario">
                    </div>

                    <div class="form-group">
                        <label class="display-4" style="font-size: 1.2em" for="Senha">Senha</label>
                        <input v-model="password" type="password" class="form-control" placeholder="Senha">
                    </div>
                    
                    <button type="submit" class="float-right btn btn-outline-primary" @click.stop.prevent="login()">Entrar</button>
                
                </form>
            </div>

            <!-- Modal -->
            <div class="modal fade" id="erro" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document"> 
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Herrar é Umano Tente Novamente</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <h5>Usuario ou senha incorretos</h5>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </template>

    <script src="../static/js/jquery-3.3.1.slim.min.js"></script>
    <script src="../static/js/popper.min.js"></script>
    <script src="../static/js/bootstrap.min.js"></script>

    <script>
        var AUTH_TOKEN;

        axios.defaults.baseURL = 'http://127.0.0.1:5000/api';

        var login = Vue.component("login",{
            template:"#login",
            data(){
                return{
                    username: null,
                    password: null
                }
            },
            methods:{
                login(){
                    axios({
                            method: 'post',
                            url: '/auth',
                            data: {
                                username: this.username,
                                password: this.password
                        }
                        }).then(function(response){
                                this.AUTH_TOKEN = response.data.access_token;
                                localStorage.setItem("AUTH_TOKEN",AUTH_TOKEN)
                                app.$data.login = localStorage.getItem("AUTH_TOKEN")
                                axios.defaults.headers.common['Authorization'] = "JWT " + localStorage.getItem("AUTH_TOKEN");
                                axios.defaults.headers.common['Content-Type'] = 'application/json';
                                window.location.href = "/"; 
                        }).catch(err => {
                            $("#erro").modal("toggle")
                            console.error(err)
                        })
                    }
            }});

        var media = Vue.component("media-global",{
            template:"#media-global",
            mounted(){
                let vm = this
                axios({
                        method: 'get',
                        url: '/consulta/funcionarios'
                        }).then(function(response){
                                vm.funcionarios = response.data
                        }).catch(err => console.error(err))
                
            },
            data(){
                return{
                    titulo:getMes() +" - "+ ( moment().year() ),
                    funcionarios:[]
                }
            }
        })
        
        var relatorio_gen =  Vue.component("relatorio-gen",{
            template:"#relatorio-gen",
            mounted(){
                let vm = this
                axios({
                        method: 'get',
                        url: '/consulta/funcionarios'
                        }).then(function(response){
                                vm.funcionarios = response.data
                        }).catch(err => console.error(err))
                
            },
            data(){
                return{
                    cabecalho:["#","FUNCIONARIO"].concat(getDays()),
                    mes: getMes(),
                    funcionarios: []
                }
            },
            props:{
                titulo:String,
            }
        })
        
        var relatorio = Vue.component("relatorio",{
            template:"#relatorio"
        });

        var dashboard = Vue.component("dashboard",{
            template:"#dashboard",

            mounted(){
                
                var ctx = document.getElementById('grafico');

                var myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange','Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                        datasets: [{
                            label: '# of Votes',
                            data: [12, 19, 3, 5, 2, 3, 12, -19, 3, 5, 2, 3],
                            backgroundColor: [],
                            borderColor: [],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }}
                                ]
                        }
                    }
                });
            }
        });

        var gerenciamento_gen = Vue.component("gerenciamento-gen",{
            template:"#gerenciamento-gen",
            data(){
                return{
                    codfun:"",
                    funcionario:"",
                    usuario:"",
                    senha:"",
                    nome:"",
                    repeticao_senha:"",
                    email:"",
                    temp:""
                }
            },
            props:{
                titulo:String,
                funcionarios:Array,
                usuarios:Array,
                id:String
            },
            methods:{
                getCod(cod){
                    this.temp = cod
                },
                addUsuario(){
                    if(this.senha == this.repeticao_senha){
                        let name = {
                                login:this.usuario,
                                senha:this.senha,
                                nome:this.nome,
                                email:this.email,
                        }
                        axios({
                        method: 'post',
                        url: '/user/cadastrar',
                        data:name
                        }).then(function(response){
                                console.log(response)
                        }).catch(err => console.error(err))
                    location.reload(true)
                    }else{
                        alert("senhas incorretas")
                    }
                    
                },
                altUsuario(){
                    if(this.senha == this.repeticao_senha){
                        axios({
                        method: 'post',
                        url: '/user/atualizar',
                        data:{
                                login:this.usuario,
                                senha:this.senha,
                                nome:this.nome,
                                email:this.email,
                                cod:this.temp
                        }
                        }).then(function(response){
                                console.log(response.data)
                        }).catch(err => console.error(err))
                      location.reload(true)
                    }else{
                        alert("senhas incorretas")
                    }
                },
                remUsuario(cod){
                    axios({
                        method: 'post',
                        url: '/user/deletar',
                        data:{
                               cod:cod
                        }
                        }).then(function(response){
                                console.log(response)
                        }).catch(err => console.error(err)) 
                      location.reload(true)
                    
                },
                addFuncionario(){
                    axios({
                        method: 'post',
                        url: '/funcionario/cadastrar',
                        data:{
                                codfun:this.codfun,
                                nomefun:this.funcionario,
                        }
                        }).then(function(response){
                                console.log(response)
                        }).catch(err => console.error(err))
                    location.reload(true)
                },
                altFuncionario(){
                    axios({
                        method: 'post',
                        url: '/funcionario/atualizar',
                        data:{
                                codfun:this.codfun,
                                nomefun:this.funcionario
                        }
                        }).then(function(response){
                                console.log(response)
                        }).catch(err => console.error(err))
                    location.reload(true)
                },
                remFuncionario(cod){
                    axios({
                        method: 'post',
                        url: '/funcionario/deletar',
                        data:{
                            codfun:cod
                        }
                        }).then(function(response){
                                console.log(response)
                        }).catch(err => console.error(err)) 
                      location.reload(true)
                }
            }
        });

        var gerenciamento = Vue.component("gerenciamento",{ 
            template:"#gerenciamento",
            data(){
                return{
                    funcionarios:[],
                    usuarios:[]
                }
            },
            mounted(){
                let vm = this
                axios({
                        method: 'get',
                        url: '/consulta/funcionarios'
                        }).then(function(response){
                            vm.funcionarios = response.data
                        }).catch(err => console.error(err))
                
                axios({
                        method: 'get',
                        url: '/consulta/usuarios'
                        }).then(function(response){ 
                            vm.usuarios = response.data
                        }).catch(err => console.error(err))
                
                }
                
        });

        var lateralmenu = Vue.component("lateralmenu",{ 
            template:"#lateralmenu",
            methods:{
                logout(){
                    app.login = null;
                    localStorage.removeItem("AUTH_TOKEN")
                    AUTH_TOKEN = null;
                    axios.defaults.headers.common['Authorization'] = null;
                    window.location.href = "/"; 
                }    
            } });

        var navbar = Vue.component("navbar",{ 
            template:"#navbar",
            methods:{
                toggle(){
                    $("#wrapper").toggleClass("toggled");
                }
            }   
        });

        var router = new VueRouter({
            routes:[
                { 
                    path:"/relatorio", 
                    name:"Relatorio",
                    component:relatorio ,
                    meta:{
                        title:"Relatorio"
                    } 
                },
                { 
                    path:"/",
                    name:"Dashboard",
                    component:dashboard,
                    meta:{
                        title:"Dashboard"
                    } 
                },
                { 
                    path:"/gerenciamento",
                    name:"Gerenciamento",
                    component: gerenciamento,
                    meta:{
                        title:"Gerenciamento"
                    }
                 }
            ]
        });
        
        var app = new Vue({
                            el:"#app",
                            router,
                            data:{
                                    login: localStorage.getItem("AUTH_TOKEN"),
                                    erro: null
                            }
                        });

    </script>

   
</body>
</html>